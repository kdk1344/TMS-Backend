<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- Dev-mapper.xml -->
<mapper namespace="com.tms.backend.mapper.TestMapper">
    <select id="searchTestProgress" parameterType="map" resultType="TestProgress">
        SELECT * FROM TEST_PROGRESS
        WHERE 1=1
        <if test="testStage != null and testStage != ''">
            AND TEST_STAGE = #{testStage}
        </if>
        <if test="majorCategory != null and majorCategory != ''">
            AND MAJOR_CATEGORY = #{majorCategory}
        </if>
        <if test="subCategory != null and subCategory != ''">
            AND SUB_CATEGORY = #{subCategory}
        </if>
        <if test="programType != null and programType != ''">
            AND PROGRAM_TYPE = #{programType}
        </if>
        <if test="testId != null and testId != ''">
            AND TEST_ID LIKE CONCAT('%', #{testId}, '%')
        </if>
        <if test="screenId != null and screenId != ''">
            AND SCREEN_ID LIKE CONCAT('%', #{screenId}, '%')
        </if>
        <if test="screenName != null and screenName != ''">
            AND SCREEN_Name LIKE CONCAT('%', #{screenName}, '%')
        </if>
        <if test="programId != null and programId != ''">
            AND PROGRAM_ID LIKE CONCAT('%', #{programId}, '%')
        </if>
        <if test="programName != null and programName != ''">
            AND PROGRAM_NAME LIKE CONCAT('%', #{programName}, '%')
        </if>
        <if test="developer != null and developer != ''">
            AND DEVELOPER LIKE CONCAT('%', #{developer}, '%')
        </if>
        <if test="testStatus != null and testStatus != ''">
            AND TEST_STATUS = #{testStatus}
        </if>
        <if test="pl != null and pl != ''">
            AND PL = #{pl}
        </if>
        <if test="ItMgr != null and ItMgr != ''">
            AND IT_MGR = #{ItMgr}
        </if>
        <if test="BusiMgr != null and BusiMgr != ''">
            AND BUSI_MGR = #{BusiMgr}
        </if>
        <if test="execCompanyMgr != null and execCompanyMgr != ''">
            AND EXEC_COMPANY_MGR = #{execCompanyMgr}
        </if>
        <if test="thirdPartyTestMgr != null and thirdPartyTestMgr != ''">
            AND THIRD_PARTY_TEST_MGR = #{thirdPartyTestMgr}
        </if>
        LIMIT #{offset}, #{size}
    </select>
	
	<select id="getTotalTestCount" parameterType="map" resultType="int">
        SELECT COUNT(*) FROM TEST_PROGRESS
        WHERE 1=1
	    <if test="testStage != null and testStage != ''">
            AND TEST_STAGE = #{testStage}
        </if>
        <if test="majorCategory != null and majorCategory != ''">
            AND MAJOR_CATEGORY = #{majorCategory}
        </if>
        <if test="subCategory != null and subCategory != ''">
            AND SUB_CATEGORY = #{subCategory}
        </if>
        <if test="programType != null and programType != ''">
            AND PROGRAM_TYPE = #{programType}
        </if>
        <if test="testId != null and testId != ''">
            AND TEST_ID LIKE CONCAT('%', #{testId}, '%')
        </if>
        <if test="programId != null and programId != ''">
            AND PROGRAM_ID LIKE CONCAT('%', #{programId}, '%')
        </if>
        <if test="programName != null and programName != ''">
            AND PROGRAM_NAME LIKE CONCAT('%', #{programName}, '%')
        </if>
        <if test="developer != null and developer != ''">
            AND DEVELOPER LIKE CONCAT('%', #{developer}, '%')
        </if>
        <if test="testStatus != null and testStatus != ''">
            AND TEST_STATUS = #{testStatus}
        </if>
        <if test="pl != null and pl != ''">
            AND PL = #{pl}
        </if>
        <if test="ItMgr != null and ItMgr != ''">
            AND IT_MGR = #{ItMgr}
        </if>
        <if test="BusiMgr != null and BusiMgr != ''">
            AND BUSI_MGR = #{BusiMgr}
        </if>
        <if test="execCompanyMgr != null and execCompanyMgr != ''">
            AND EXEC_COMPANY_MGR = #{execCompanyMgr}
        </if>
        <if test="thirdPartyTestMgr != null and thirdPartyTestMgr != ''">
            AND THIRD_PARTY_TEST_MGR = #{thirdPartyTestMgr}
        </if>
	</select>
	
	<!-- 테스트 진행 현황 추가 -->
    <insert id="inserttestProgress" parameterType="TestProgress" useGeneratedKeys="true" keyProperty="seq">
	    INSERT INTO TEST_PROGRESS (
	        TEST_STAGE, MAJOR_CATEGORY, SUB_CATEGORY, MINOR_CATEGORY,
		    TEST_ID, PROGRAM_TYPE, PROGRAM_ID, PROGRAM_NAME,
		    DEFECT_TYPE, DEFECT_SEVERITY, DEFECT_DESCRIPTION, DEFECT_REGISTRAR,
		    DEFECT_DISCOVERY_DATE, DEFECT_HANDLER, DEFECT_SCHEDULED_DATE,
		    DEFECT_COMPLETION_DATE, DEFECT_RESOLUTION_DETAILS, PL,
		    PL_CONFIRM_DATE, ORIGINAL_DEFECT_NUMBER, PL_DEFECT_JUDGE_CLASS,
		    PL_COMMENTS, DEFECT_REG_CONFIRM_DATE, DEFECT_REGISTRAR_COMMENT,
		    DEFECT_STATUS, INIT_REGISTRAR, LAST_MODIFIER
		) VALUES (
		    #{testStage}, #{majorCategory}, #{subCategory}, #{minorCategory},
		    #{testId}, #{programType}, #{programId}, #{programName},
		    #{defectType}, #{defectSeverity}, #{defectDescription}, #{defectRegistrar},
		    #{defectDiscoveryDate}, #{defectHandler}, #{defectScheduledDate},
		    #{defectCompletionDate}, #{defectResolutionDetails}, #{pl},
		    #{plConfirmDate}, #{originalDefectNumber}, #{plDefectJudgeClass},
		    #{plComments}, #{defectRegConfirmDate}, #{defectRegistrarComment},
		    #{defectStatus}, #{initRegistrar}, #{lastModifier}
		)
	</insert>
	
	<!-- 테스트 현황 수정 -->
	<update id="updatetestProgress" parameterType="TestProgress">
		UPDATE TEST_PROGRESS
        SET 
            TEST_STAGE = #{testStage},
	        MAJOR_CATEGORY = #{majorCategory},
	        SUB_CATEGORY = #{subCategory},
	        MINOR_CATEGORY = #{minorCategory},
	        TEST_ID = #{testId},
	        PROGRAM_TYPE = #{programType},
	        PROGRAM_ID = #{programId},
	        PROGRAM_NAME = #{programName},
	        DEFECT_TYPE = #{defectType},
	        DEFECT_SEVERITY = #{defectSeverity},
	        DEFECT_DESCRIPTION = #{defectDescription},
	        DEFECT_REGISTRAR = #{defectRegistrar},
	        DEFECT_DISCOVERY_DATE = #{defectDiscoveryDate},
	        DEFECT_HANDLER = #{defectHandler},
	        DEFECT_SCHEDULED_DATE = #{defectScheduledDate},
	        DEFECT_COMPLETION_DATE = #{defectCompletionDate},
	        DEFECT_RESOLUTION_DETAILS = #{defectResolutionDetails},
	        PL = #{pl},
	        PL_CONFIRM_DATE = #{plConfirmDate},
	        ORIGINAL_DEFECT_NUMBER = #{originalDefectNumber},
	        PL_DEFECT_JUDGE_CLASS = #{plDefectJudgeClass},
	        PL_COMMENTS = #{plComments},
	        DEFECT_REG_CONFIRM_DATE = #{defectRegConfirmDate},
	        DEFECT_REGISTRAR_COMMENT = #{defectRegistrarComment},
	        DEFECT_STATUS = #{defectStatus},
	        IT_MGR = #{itMgr},
	        IT_TEST_DATE = #{itTestDate},
	        IT_CONFIRM_DATE = #{itConfirmDate},
	        IT_TEST_RESULT = #{itTestResult},
	        IT_TEST_NOTES = #{itTestNotes},
	        BUSI_MGR = #{busiMgr},
	        BUSI_TEST_DATE = #{busiTestDate},
	        BUSI_CONFIRM_DATE = #{busiConfirmDate},
	        BUSI_TEST_RESULT = #{busiTestResult},
	        BUSI_TEST_NOTES = #{busiTestNotes},
	        THIRD_PARTY_TEST_MGR = #{thirdPartyTestMgr},
	        THIRD_PARTY_TEST_DATE = #{thirdPartyTestDate},
	        THIRD_PARTY_CONFIRM_DATE = #{thirdPartyConfirmDate},
	        THIRD_TEST_RESULT = #{thirdTestResult},
	        THIRD_PARTY_TEST_NOTES = #{thirdPartyTestNotes},
	        DEV_STATUS = #{devStatus},
	        INIT_REGISTRAR = #{initRegistrar},
	        LAST_MODIFIED_DATE = CURRENT_TIMESTAMP,
	        LAST_MODIFIER = #{lastModifier}
        WHERE SEQ = #{seq}
    </update>
	
	<!-- 테스트 진행 현황 삭제 -->
	<delete id="deleteTestProgress" parameterType="int">
		DELETE FROM TEST_PROGRESS WHERE SEQ = #{seq}
	</delete>
	
	<!-- 테스트 정보 추출 -->
	<select id="getTestById" resultType="TestProgress">
		SELECT * FROM TEST_PROGRESS
        WHERE SEQ = #{seq}
	</select>
	
</mapper>