<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- user-mapper.xml -->
<mapper namespace="com.tms.backend.mapper.DefectMapper">
    <select id="searchDefects" parameterType="map" resultType="Defect">
	    SELECT * 
	    FROM DEFECT
	    WHERE 1=1
	    <if test="testCategory != null and testCategory != ''">
	        AND TEST_CATEGORY = #{testCategory}
	    </if>
	    <if test="taskCategory != null and taskCategory != ''">
	        AND TASK_CATEGORY = #{taskCategory}
	    </if>
	    <if test="taskSubCategory != null and taskSubCategory != ''">
	        AND TASK_SUB_CATEGORY = #{taskSubCategory}
	    </if>
	    <if test="defectSeverity != null and defectSeverity != ''">
	        AND DEFECT_SEVERITY = #{defectSeverity}
	    </if>
	    <if test="defectNumber != null and defectNumber != ''">
	        AND DEFECT_SEQ = #{defectNumber}
	    </if>
	    <if test="defectRegistrar != null and defectRegistrar != ''">
	        AND DEFECT_REGISTRAR = #{defectRegistrar}
	    </if>
	    <if test="defectHandler != null and defectHandler != ''">
	        AND DEFECT_HANDLER = #{defectHandler}
	    </if>
	    <if test="defectStatus != null and defectStatus != ''">
	        AND DEFECT_STATUS = #{defectStatus}
	    </if>
	    ORDER BY DEFECT_SEQ DESC
	    LIMIT #{offset}, #{size}
	</select>
	
	<select id="countDefects" parameterType="map" resultType="int">
	    SELECT COUNT(*)
	    FROM DEFECT
	    WHERE 1=1
	    <if test="testCategory != null and testCategory != ''">
	        AND TEST_CATEGORY = #{testCategory}
	    </if>
	    <if test="taskCategory != null and taskCategory != ''">
	        AND TASK_CATEGORY = #{taskCategory}
	    </if>
	    <!-- 나머지 필터 조건들 동일하게 적용 -->
	</select>
	
	<delete id="deleteDefect" parameterType="int">
		DELETE FROM DEFECT WHERE DEFECT_SEQ = #{seq}
	</delete>
	
	<insert id="insertdefect" parameterType="Defect">
		INSERT INTO DEFECT (
	    TEST_STAGE, MAJOR_CATEGORY, SUB_CATEGORY, 
	    TEST_ID, PROGRAM_TYPE, PROGRAM_ID, PROGRAM_NAME, 
	    DEFECT_TYPE, DEFECT_SEVERITY, DEFECT_DESCRIPTION, 
	    DEFECT_REGISTRAR, DEFECT_REG_DATE, DEFECT_HANDLER, 
	    DEFECT_SCHEDULED_DATE, DEFECT_COMPLETION_DATE, 
	    DEFECT_RESOLUTION_DETAILS, PL, PL_CONFIRM_DATE, 
	    ORIGINAL_DEFECT_NUMBER, PL_DEFECT_JUDGE_CLASS, PL_COMMENTS, 
	    DEFECT_REG_CONFIRM_DATE, DEFECT_REGISTRAR_COMMENT, 
	    DEFECT_STATUS, INIT_CREATER, LAST_MODIFIER
	) VALUES (
	    #{testStage}, #{majorCategory}, #{subCategory}, 
	    #{testId}, #{programType}, #{programId}, #{programName}, 
	    #{defectType}, #{defectSeverity}, #{defectDescription}, 
	    #{defectRegistrar}, #{defectRegDate}, #{defectHandler}, 
	    #{defectScheduledDate}, #{defectCompletionDate}, 
	    #{defectResolutionDetails}, #{pl}, #{plConfirmDate}, 
	    #{originalDefectNumber}, #{plDefectJudgeClass}, #{plComments}, 
	    #{defectRegConfirmDate}, #{defectRegistrarComment}, 
	    #{defectStatus}, #{initCreater}, #{lastModifier}
    )
	</insert>
	
	<select id="countDefect" parameterType="String" resultType="int">
	    SELECT COUNT(*)
	    FROM defect a
	    INNER JOIN dev_progress b
	    ON a.PROGRAM_ID = b.PROGRAM_ID
	    <if test="managerType == 'thirdParty'">
            AND a.DEFECT_REGISTRAR = b.THIRD_PARTY_TEST_MGR
        </if>
        <if test="managerType == 'it'">
            AND a.DEFECT_REGISTRAR = b.IT_MGR
        </if>
        <if test="managerType == 'busi'">
            AND a.DEFECT_REGISTRAR = b.BUSI_MGR
        </if>
        WHERE 1=1
	        AND a.TEST_STAGE = "단위테스트"
	        AND a.PROGRAM_ID = #{programId}
	</select>
	
	<select id="countDefectSoultions" parameterType="String" resultType="int">
	    SELECT COUNT(*)
	    FROM defect a
	    INNER JOIN dev_progress b
	    ON a.PROGRAM_ID = b.PROGRAM_ID
	    <if test="managerType == 'thirdParty'">
            AND a.DEFECT_REGISTRAR = b.THIRD_PARTY_TEST_MGR
        </if>
        <if test="managerType == 'it'">
            AND a.DEFECT_REGISTRAR = b.IT_MGR
        </if>
        <if test="managerType == 'busi'">
            AND a.DEFECT_REGISTRAR = b.BUSI_MGR
        </if>
	    WHERE 1=1
	        AND a.TEST_STAGE = "단위테스트"
	        AND a.PROGRAM_ID = #{programId}
	        AND a.DEFECT_COMPLETION_DATE is not null
	</select>

	
</mapper>